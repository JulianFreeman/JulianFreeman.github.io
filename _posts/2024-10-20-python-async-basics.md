---
title: Python async 笔记
date: 2024-10-20 08:56:00 -0400
categories: [学习笔记, Python]
tags: [async]
description: 本文记录自己对 async 的理解
---

## 概念解释

开始之前先放几段从 ChatGPT 上摘的概念解析吧。

### 同步 vs 异步

同步指的是 **按顺序执行** 任务。每个任务必须等待前一个任务完成后才能继续，整个程序会按照预定的顺序进行。当一个任务在执行时，程序的其他部分会被阻塞，直到这个任务完成。

- 特点:
    - 阻塞：如果某个任务正在执行，其他任务必须等待。
    - 执行顺序明确：任务按顺序依次执行。
    - 适用于：当任务的执行顺序非常重要时使用同步，例如必须确保前一个任务完成后才能进行下一个任务的情况。

异步指的是 **任务可以并发** 执行，不必等待其他任务完成。程序不会因为某个任务的执行而阻塞，可以继续进行其他任务。异步编程常用于处理 I/O 密集型任务（如文件读取、网络请求等），这样可以提高程序的效率。

- 特点:
    - 非阻塞：一个任务开始后，程序不会等待它完成，而是继续执行其他任务。
    - 并发：多个任务可以同时进行，通常使用回调函数、事件循环或异步/等待机制。
    - 适用于：当任务可以并行处理，且不需要严格按顺序执行时，适合异步。例如处理网络请求、读取文件等 I/O 操作。

### 异步 vs 多线程

异步编程是一种基于 **事件驱动** 或 **回调机制** 的模型。它不依赖多线程，而是通过 **非阻塞** 操作，允许程序在等待某些任务（如I/O操作）时执行其他任务。

- 原理：异步模型通常基于 **事件循环**，任务（如网络请求、文件读写等）在后台非阻塞地运行。当任务完成时，事件循环会收到通知并处理相应的回调。
- 执行环境：单线程（通常），如 Python 的 `asyncio` 或 JavaScript 的异步机制。这种方式不会创建额外的线程，而是在单个线程中通过异步 I/O 机制处理任务。
- 适用场景：异步编程适合处理大量 I/O 密集型任务，如网络请求、文件操作等。因为这些任务大部分时间都在等待数据，不需要 CPU 长时间参与计算。
- 优势：
    - 不会创建多个线程，避免了线程间的同步开销和复杂性。
    - 适合处理大量的 I/O 密集型任务。
- 局限：
    - 异步编程在处理 CPU 密集型任务时并不擅长，因为它依赖于单个线程和事件循环。

多线程是通过 **多个线程** 来并发执行任务。每个线程在同一个进程中运行，并共享相同的内存空间。它允许多个任务在多个线程中 **并行** 执行。

- 原理：在多线程编程中，程序可以创建多个线程，这些线程可以在同一时刻并行执行不同的任务。在多核处理器上，多个线程甚至可以真正同时运行。
- 执行环境：多线程通常在多核处理器中发挥最大优势，因为多个线程可以在多个核心上同时执行，适合处理 CPU 密集型任务。
- 适用场景：适合 CPU 密集型任务，比如图像处理、数据计算等。每个线程可以独立运行，彼此间共享数据，同时能提高程序的并发性能。
- 优势：
    - 适合处理 CPU 密集型任务，可以通过多核处理器充分利用硬件资源。
    - 对于长时间运行的任务，通过多线程可以提高程序的执行效率。
- 局限：
    - 线程间的数据共享和同步变得复杂，容易引发竞争条件、死锁等问题。
    - 多线程的上下文切换（线程调度）有一定的开销，可能导致性能下降。

异步 ≠ 多线程：异步编程通常是在 **单线程** 环境中通过非阻塞 I/O 和事件循环来实现并发，而多线程则是真正的并行执行，通过多个线程处理多个任务。

协作并非对立：异步和多线程并不是对立的，两者可以结合使用。例如，异步任务可以在后台使用多个线程执行复杂的操作，特别是在需要大量 CPU 计算的情况下。

### 协程

**协程（Coroutine）是一种比线程更加轻量级的并发机制，允许函数在执行过程中可以暂停和恢复，并与其他协程协作执行。** 它与传统的函数调用不同，协程可以在某个地方暂停，保存当前的状态，等被调用时继续从上次暂停的地方继续执行。协程通常与异步编程相关，特别是在处理 I/O 密集型任务时非常有用。

1. 协程 vs 线程

- 线程是由操作系统管理的，通常是并行执行的，多个线程之间可能共享数据，需要使用锁等同步机制来防止资源竞争。
- 协程是由程序自身管理的，可以认为是协作式的线程，它们是单线程的并发执行模型。协程不会像线程一样由操作系统调度，而是通过程序中的某些机制（如事件循环）手动调度。

2. 协程的特点

- 可暂停与恢复：协程的执行可以在某个时刻暂停，保存当前的执行状态，然后稍后恢复继续执行。这种暂停和恢复通常通过 `yield` 或 `await` 关键字来实现。
- 协作式并发：协程并不会像线程那样自动并行执行，它们通过显式的方式让出控制权给其他协程，这种协作机制允许多个协程在同一个线程中“同时”执行任务，但实际上它们是交替运行的。
- 轻量级：协程比线程更加轻量，因为它们不需要线程的上下文切换，也不需要操作系统的调度。一个程序中可以拥有成千上万个协程，而线程的数量则受到更多系统资源的限制。

> 未完待续
